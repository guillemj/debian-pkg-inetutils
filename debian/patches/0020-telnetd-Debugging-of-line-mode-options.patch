From 60d9a04cad65e3bfb850f90876f3cd8beb696edd Mon Sep 17 00:00:00 2001
From: Mats Erik Andersson <gnu@gisladisker.se>
Date: Tue, 21 Feb 2017 18:50:30 +0100
Subject: [PATCH 20/64] telnetd: Debugging of line mode options.

---
 ChangeLog          | 14 +++++++++
 telnetd/telnetd.c  | 12 ++++++--
 telnetd/termstat.c | 73 +++++++++++++++++++++++++++++++++++-----------
 telnetd/utility.c  |  2 +-
 4 files changed, 80 insertions(+), 21 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index f0289780..7fee820a 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,17 @@
+2017-02-21  Mats Erik Andersson  <gnu@gisladisker.se>
+
+	telnetd: Debugging of mainly line mode options.
+
+	* telnetd/telnetd.c (telnetd_run): Assemble flow control data
+	in new string variable DATA, then send it and include for debug
+	reporting in category 'options'.
+	* telnetd/termstat.c (localstat, flowstat, clientstat): Likewise,
+	also for line mode data.
+
+	* telnetd/utility.c (printsub) <LM_MODE>: Test TBUF[0]
+	to calculate replacement string, since TBUF[1] is not
+	guaranteed to be initialized by the preceding snprintf().
+
 2016-05-23  Mats Erik Andersson  <gnu@gisladisker.se>
 
 	hostname: Avoid a trailing space.
diff --git a/telnetd/telnetd.c b/telnetd/telnetd.c
index 0bf102ac..3902d77d 100644
--- a/telnetd/telnetd.c
+++ b/telnetd/telnetd.c
@@ -698,9 +698,15 @@ telnetd_run (void)
 	      int newflow = (c & TIOCPKT_DOSTOP) ? 1 : 0;
 	      if (newflow != flowmode)
 		{
-		  net_output_data ("%c%c%c%c%c%c",
-				   IAC, SB, TELOPT_LFLOW,
-				   flowmode ? LFLOW_ON : LFLOW_OFF, IAC, SE);
+		  char data[6];
+
+		  sprintf (data, "%c%c%c%c%c%c",
+			   IAC, SB, TELOPT_LFLOW,
+			   flowmode ? LFLOW_ON : LFLOW_OFF,
+			   IAC, SE);
+		  net_output_datalen (data, sizeof (data));
+		  DEBUG (debug_options, 1,
+			 printsub ('>', data + 2, sizeof (data) - 2));
 		}
 	    }
 
diff --git a/telnetd/termstat.c b/telnetd/termstat.c
index c36e6dee..9dbfa4d7 100644
--- a/telnetd/termstat.c
+++ b/telnetd/termstat.c
@@ -304,10 +304,18 @@ localstat (void)
 	}
       else if (lmodetype == REAL_LINEMODE)
 	{
+	  char data[7];
+
 	  send_do (TELOPT_LINEMODE, 1);
 	  /* send along edit modes */
-	  net_output_data ("%c%c%c%c%c%c%c", IAC, SB,
-			   TELOPT_LINEMODE, LM_MODE, useeditmode, IAC, SE);
+	  sprintf (data, "%c%c%c%c%c%c%c",
+		   IAC, SB, TELOPT_LINEMODE,
+		   LM_MODE, useeditmode,
+		   IAC, SE);
+	  net_output_datalen (data, sizeof (data));
+	  DEBUG (debug_options, 1,
+		 printsub ('>', data + 2, sizeof (data) - 2));
+
 	  editmode = useeditmode;
 	}
       linemode = uselinemode;
@@ -331,8 +339,16 @@ localstat (void)
 	  /*
 	   * Send along appropriate edit mode mask.
 	   */
-	  net_output_data ("%c%c%c%c%c%c%c", IAC, SB,
-			   TELOPT_LINEMODE, LM_MODE, useeditmode, IAC, SE);
+	  char data[7];
+
+	  sprintf (data, "%c%c%c%c%c%c%c",
+		   IAC, SB, TELOPT_LINEMODE,
+		   LM_MODE, useeditmode,
+		   IAC, SE);
+	  net_output_datalen (data, sizeof (data));
+	  DEBUG (debug_options, 1,
+		 printsub ('>', data + 2, sizeof (data) - 2));
+
 	  editmode = useeditmode;
 	}
 
@@ -375,20 +391,29 @@ flowstat (void)
 {
   if (his_state_is_will (TELOPT_LFLOW))
     {
+      char data[6];
+
       if (tty_flowmode () != flowmode)
 	{
 	  flowmode = tty_flowmode ();
-	  net_output_data ("%c%c%c%c%c%c",
-			   IAC, SB, TELOPT_LFLOW,
-			   flowmode ? LFLOW_ON : LFLOW_OFF, IAC, SE);
+	  sprintf (data, "%c%c%c%c%c%c",
+		   IAC, SB, TELOPT_LFLOW,
+		   flowmode ? LFLOW_ON : LFLOW_OFF,
+		   IAC, SE);
+	  net_output_datalen (data, sizeof (data));
+	  DEBUG (debug_options, 1,
+		 printsub ('>', data + 2, sizeof (data) - 2));
 	}
       if (tty_restartany () != restartany)
 	{
 	  restartany = tty_restartany ();
-	  net_output_data ("%c%c%c%c%c%c",
-			   IAC, SB, TELOPT_LFLOW,
-			   restartany ? LFLOW_RESTART_ANY
-			   : LFLOW_RESTART_XON, IAC, SE);
+	  sprintf (data, "%c%c%c%c%c%c",
+		   IAC, SB, TELOPT_LFLOW,
+		   restartany ? LFLOW_RESTART_ANY : LFLOW_RESTART_XON,
+		   IAC, SE);
+	  net_output_datalen (data, sizeof (data));
+	  DEBUG (debug_options, 1,
+		 printsub ('>', data + 2, sizeof (data) - 2));
 	}
     }
 }
@@ -451,6 +476,8 @@ clientstat (register int code, register int parm1, register int parm2)
 	  if (lmodetype == REAL_LINEMODE && uselinemode)
 	    if (uselinemode)
 	      {
+		char data[7];
+
 		useeditmode = 0;
 		if (tty_isediting ())
 		  useeditmode |= MODE_EDIT;
@@ -460,9 +487,15 @@ clientstat (register int code, register int parm1, register int parm2)
 		  useeditmode |= MODE_SOFT_TAB;
 		if (tty_islitecho ())
 		  useeditmode |= MODE_LIT_ECHO;
-		net_output_data ("%c%c%c%c%c%c%c", IAC,
-				 SB, TELOPT_LINEMODE, LM_MODE,
-				 useeditmode, IAC, SE);
+
+		sprintf (data, "%c%c%c%c%c%c%c",
+			 IAC, SB, TELOPT_LINEMODE,
+			 LM_MODE, useeditmode,
+			 IAC, SE);
+		net_output_datalen (data, sizeof (data));
+		DEBUG (debug_options, 1,
+		       printsub ('>', data + 2, sizeof (data) - 2));
+
 		editmode = useeditmode;
 	      }
 
@@ -520,9 +553,15 @@ clientstat (register int code, register int parm1, register int parm2)
 
 	    if (!ack)
 	      {
-		net_output_data ("%c%c%c%c%c%c%c", IAC,
-				 SB, TELOPT_LINEMODE, LM_MODE,
-				 useeditmode | MODE_ACK, IAC, SE);
+		char data[7];
+
+		sprintf (data, "%c%c%c%c%c%c%c",
+			 IAC, SB, TELOPT_LINEMODE,
+			 LM_MODE, useeditmode | MODE_ACK,
+			 IAC, SE);
+		net_output_datalen (data, sizeof (data));
+		DEBUG (debug_options, 1,
+		       printsub ('>', data + 2, sizeof (data) - 2));
 	      }
 
 	    editmode = useeditmode;
diff --git a/telnetd/utility.c b/telnetd/utility.c
index e493dff2..15241797 100644
--- a/telnetd/utility.c
+++ b/telnetd/utility.c
@@ -1220,7 +1220,7 @@ printsub (int direction, unsigned char *pointer, int length)
 		      pointer[2] & MODE_SOFT_TAB ? "|SOFT_TAB" : "",
 		      pointer[2] & MODE_LIT_ECHO ? "|LIT_ECHO" : "",
 		      pointer[2] & MODE_ACK ? "|ACK" : "");
-	    debug_output_data ("%s", tbuf[1] ? &tbuf[1] : "0");
+	    debug_output_data ("%s", tbuf[0] ? &tbuf[1] : "0");
 	  }
 
 	  if (pointer[2] & ~(MODE_EDIT | MODE_TRAPSIG | MODE_ACK))
-- 
2.28.0.163.g6104cc2f0b6

