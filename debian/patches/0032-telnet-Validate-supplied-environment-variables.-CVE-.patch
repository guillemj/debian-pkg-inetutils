From bacd4ddce3cbb6ac731cad57c56722a94a7685f8 Mon Sep 17 00:00:00 2001
From: Simon Josefsson <simon@josefsson.org>
Date: Wed, 1 Jan 2020 15:28:54 +0100
Subject: [PATCH 32/64] telnet: Validate supplied environment variables.
 CVE-2019-0053

telnet/telnet.c (suboption): Use snprintf instead of sprintf.
telnet/utilities.c (printsub): Likewise.
---
 ChangeLog          |   6 +++
 NEWS               | 109 ++++++++++++++++++++++++++++++++++++++++++++-
 telnet/telnet.c    |   6 +--
 telnet/utilities.c |   2 +-
 4 files changed, 117 insertions(+), 6 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 9a4b18c4..7733004f 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,9 @@
+2020-01-01  Simon Josefsson  <simon@josefsson.org>
+
+	telnet: Validate supplied environment variables. CVE-2019-0053
+	* telnet/telnet.c (suboption): Use snprintf instead of sprintf.
+	* telnet/utilities.c (printsub): Likewise.
+
 2020-01-01  Guillem Jover  <guillem@hadrons.org>  (tiny change)
 
 	* ping/ping_echo.c (struct icmp_diag): Fix typo.
diff --git a/NEWS b/NEWS
index 53cacfa2..96c9dfaa 100644
--- a/NEWS
+++ b/NEWS
@@ -7,8 +7,113 @@ Please send inetutils bug reports to <bug-inetutils@gnu.org>.
 
 * ftp
 
-Allow invocation, as well as command `open', to accept an explicit
-remote user name as extended host argument: `user@host'.
+** Allow invocation, as well as command `open', to accept an explicit
+** remote user name as extended host argument: `user@host'.
+
+** Portability to Android.
+
+Without a check for HAVE_DECL_GETPASS and without making a local
+function declaration, the implicit declaration causes crashes on
+64-bit systems lacking declared getpass(), such as Android.  See
+http://lists.gnu.org/archive/html/bug-inetutils/2016-10/msg00000.html
+
+* ftpd
+
+** Mention mandatory argument for <max-timeout>.
+
+* rcp
+
+** Integer overflow.
+
+During transmission of large files, size exceeding 2GB, a long integer
+variable overflows.  Issue reported and identified by Wenlin Kang in
+http://lists.gnu.org/archive/html/bug-inetutils/2015-07/msg00004.html
+
+* hostname
+
+** Avoid a trailing space.
+
+Suppress the space character after the last presented IP number.
+Problem reported by Terje Strand in
+http://lists.gnu.org/archive/html/bug-inetutils/2016-04/msg00001.html
+
+** Make -F handle comment-only input files without trailing newline.
+Problem reported by Omer Anson <oaanson@gmail.com> in
+https://lists.gnu.org/archive/html/bug-inetutils/2017-06/msg00010.html
+
+* syslogd
+
+** Redefine faulty macro LOG_MAKEPRI whenever needed.
+
+Systems with Glibc header file <syslog.h> prior to 2.17, are not
+correctly defining the helper macro LOG_MAKEPRI.  This effects our
+syslog service whenever it receives kernel messages from a remote
+host.  The issue was mentioned in Debian's BTS as report #729666.
+
+* tftpd
+
+** AIX portability
+
+** Add LOG_NDELAY to openlog().  The file descriptor for logging must
+** be active before chrooting happens.
+
+* traceroute
+
+** Subprivileged use case.
+
+A fallback for ICMP tracing relevant to GNU/Linux is implemented,
+allowing a rudimentary but suid-less use case.  The ability to
+identify intermediary hosts is missing, due to the crippled capability
+of receiving ICMP packets other than ICMP_ECHOREPLY.
+
+* telnet
+
+** Telnet -E(no escape) is treating _POSIX_VDISABLE char as escape.
+
+Causes problems when sending binary data through telnet connections.
+
+** Validate supplied environment variables. CVE-2019-0053
+
+* telnetd
+
+** Use tty, not pty on Solaris.
+
+Setting of terminal attributes as well setting of window size must be
+done via the slave descriptor, not the master descriptor.
+
+** Scrub USER from environment.
+
+Discard the environment variable USER.  It will later be set properly
+for autologin, but at least one BSD system passes a preset value when
+telnetd starts, a value which will cause rejected login when autologin
+is not in effect.
+
+** Portability of TTY termcap to Solaris systems.
+
+** Portable option debugging.
+
+BSD systems assign IAC and _POSIX_VDISABLE the common decimal value
+255. Hence the NVT enforces value duplication more often during their
+transmission, than GNU and Solaris systems do.
+
+** Premature connection closure.
+
+When many connections are attempted in quick succession, a substantial
+number of them are cancelled.  This does not appear for manual use
+cases, but for contrived automated set-ups.  The cause seems to be a
+change in the evaluation of pty_read(), which was done to coincide
+with the condition in use by the original BSD implementation.  Issue
+reported and suggested by Chris Severance in
+http://lists.gnu.org/archive/html/bug-inetutils/2015-07/msg00006.html
+
+* whois
+
+** Update Canadian TLD server.
+
+Old host name no longer exists.  Reported by Neil Mayhem:
+http://lists.gnu.org/archive/html/bug-inetutils/2017-01/msg00000.html
+
+* Improved documentation, self-tests and build environment.
 
 June 9, 2015
 Version 1.9.4:
diff --git a/telnet/telnet.c b/telnet/telnet.c
index 97be8add..6e00513a 100644
--- a/telnet/telnet.c
+++ b/telnet/telnet.c
@@ -861,7 +861,7 @@ suboption (void)
 	  len = strlen (name) + 4 + 2;
 	  if (len < NETROOM ())
 	    {
-	      sprintf ((char *) temp, "%c%c%c%c%s%c%c", IAC, SB, TELOPT_TTYPE,
+	      snprintf ((char *) temp, sizeof (temp), "%c%c%c%c%s%c%c", IAC, SB, TELOPT_TTYPE,
 		       TELQUAL_IS, name, IAC, SE);
 	      ring_supply_data (&netoring, temp, len);
 	      printsub ('>', &temp[2], len - 2);
@@ -885,7 +885,7 @@ suboption (void)
 
 	  TerminalSpeeds (&ispeed, &ospeed);
 
-	  sprintf ((char *) temp, "%c%c%c%c%d,%d%c%c", IAC, SB, TELOPT_TSPEED,
+	  snprintf ((char *) temp, sizeof (temp), "%c%c%c%c%d,%d%c%c", IAC, SB, TELOPT_TSPEED,
 		   TELQUAL_IS, (int) ospeed, (int) ispeed, IAC, SE);
 	  len = strlen ((char *) temp + 4) + 4;	/* temp[3] is 0 ... */
 
@@ -999,7 +999,7 @@ suboption (void)
 	      send_wont (TELOPT_XDISPLOC, 1);
 	      break;
 	    }
-	  sprintf ((char *) temp, "%c%c%c%c%s%c%c", IAC, SB, TELOPT_XDISPLOC,
+	  snprintf ((char *) temp, sizeof (temp), "%c%c%c%c%s%c%c", IAC, SB, TELOPT_XDISPLOC,
 		   TELQUAL_IS, dp, IAC, SE);
 	  len = strlen ((char *) temp + 4) + 4;	/* temp[3] is 0 ... */
 
diff --git a/telnet/utilities.c b/telnet/utilities.c
index 7bd53967..195e90c4 100644
--- a/telnet/utilities.c
+++ b/telnet/utilities.c
@@ -732,7 +732,7 @@ printsub (char direction, unsigned char *pointer, int length)
 	      {
 		char tbuf[64];
 
-		sprintf (tbuf, "%s%s%s%s%s",
+		snprintf (tbuf, sizeof (tbuf), "%s%s%s%s%s",
 			 pointer[2] & MODE_EDIT ? "|EDIT" : "",
 			 pointer[2] & MODE_TRAPSIG ? "|TRAPSIG" : "",
 			 pointer[2] & MODE_SOFT_TAB ? "|SOFT_TAB" : "",
-- 
2.28.0.163.g6104cc2f0b6

